<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registro de Persona</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <div class="container">
      <h1>Registro de Personal</h1>

      <a href="/administrar" class="administrar-link">Administrar Registros</a>
      <div class="separator"></div>
      <form id="registroForm" action="/registrar" method="post" novalidate>
        <div class="form-group">
          <label for="dni">DNI: *</label>
          <input
            type="text"
            id="dni"
            name="dni"
            required
            maxlength="8"
            pattern="[0-9]{7,8}"
          />
          <div class="error-message" id="dni-error">
            El DNI debe tener entre 7 y 8 dígitos
          </div>
        </div>
        <div class="form-group">
          <label for="nombre">Nombre: *</label>
          <input
            type="text"
            id="nombre"
            name="nombre"
            required
            maxlength="50"
            pattern="[A-Za-zÀ-ÿ\s]+"
          />
          <div class="error-message" id="nombre-error">
            El nombre es requerido y solo debe contener letras
          </div>
        </div>
        <div class="form-group">
          <label for="apellido">Apellido: *</label>
          <input
            type="text"
            id="apellido"
            name="apellido"
            required
            maxlength="50"
            pattern="[A-Za-zÀ-ÿ\s]+"
          />
          <div class="error-message" id="apellido-error">
            El apellido es requerido y solo debe contener letras
          </div>
        </div>
        <div class="form-group">
          <label for="direccion">Dirección:</label>
          <input type="text" id="direccion" name="direccion" maxlength="100" />
          <div class="error-message" id="direccion-error"></div>
        </div>
        <div class="form-group">
          <label for="telefono">Teléfono:</label>
          <input
            type="text"
            id="telefono"
            name="telefono"
            maxlength="15"
            pattern="[0-9\-\+\s\(\)]+"
          />
          <div class="error-message" id="telefono-error">
            El teléfono solo debe contener números, espacios, guiones y
            paréntesis
          </div>
        </div>
        <button type="submit" id="submitBtn">Registrar</button>
      </form>
    </div>

    <!-- Modal para el mensaje de registro exitoso -->
    <div id="modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="cerrarMensaje()">&times;</span>
        <p>¡Registro exitoso!</p>
      </div>
    </div>

    <!-- Script para validaciones y modal -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("registroForm");
        const submitBtn = document.getElementById("submitBtn");
        const modal = document.getElementById("modal");

        // Elementos del formulario
        const dni = document.getElementById("dni");
        const nombre = document.getElementById("nombre");
        const apellido = document.getElementById("apellido");
        const direccion = document.getElementById("direccion");
        const telefono = document.getElementById("telefono");

        // Función para validar un campo individual
        function validateField(
          field,
          errorId,
          customValidation = null,
          showErrors = true
        ) {
          const errorElement = document.getElementById(errorId);
          let isValid = true;

          // Limpiar estilos previos
          field.classList.remove("error");
          errorElement.style.display = "none";

          // Solo validar si el campo ha sido tocado o si showErrors es true
          const fieldTouched = field.dataset.touched === "true";

          // Validar si es requerido y está vacío
          if (field.hasAttribute("required") && field.value.trim() === "") {
            isValid = false;
            if (showErrors && fieldTouched) {
              errorElement.textContent = "Este campo es requerido";
            }
          }
          // Validar patrón si existe
          else if (
            field.pattern &&
            field.value.trim() !== "" &&
            !new RegExp(field.pattern).test(field.value)
          ) {
            isValid = false;
            if (showErrors && fieldTouched) {
              // Mantener el mensaje de error predefinido
            }
          }
          // Validación personalizada
          else if (customValidation && field.value.trim() !== "") {
            const customError = customValidation(field.value);
            if (customError) {
              isValid = false;
              if (showErrors && fieldTouched) {
                errorElement.textContent = customError;
              }
            }
          }

          // Mostrar error solo si no es válido, showErrors es true y el campo fue tocado
          if (!isValid && showErrors && fieldTouched) {
            field.classList.add("error");
            errorElement.style.display = "block";
          }

          return isValid;
        }

        // Validaciones personalizadas
        function validateDNI(value) {
          if (value.length < 7 || value.length > 8) {
            return "El DNI debe tener entre 7 y 8 dígitos";
          }
          if (!/^\d+$/.test(value)) {
            return "El DNI solo debe contener números";
          }
          return null;
        }

        function validateName(value) {
          if (value.length < 2) {
            return "Debe tener al menos 2 caracteres";
          }
          if (!/^[A-Za-zÀ-ÿ\s]+$/.test(value)) {
            return "Solo se permiten letras y espacios";
          }
          return null;
        }

        function validatePhone(value) {
          if (value.trim() !== "" && !/^[0-9\-\+\s\(\)]+$/.test(value)) {
            return "Formato de teléfono inválido";
          }
          return null;
        }

        // Validar formulario completo
        function validateForm(showErrors = false) {
          let isFormValid = true;

          isFormValid &= validateField(
            dni,
            "dni-error",
            validateDNI,
            showErrors
          );
          isFormValid &= validateField(
            nombre,
            "nombre-error",
            validateName,
            showErrors
          );
          isFormValid &= validateField(
            apellido,
            "apellido-error",
            validateName,
            showErrors
          );
          isFormValid &= validateField(
            direccion,
            "direccion-error",
            null,
            showErrors
          );
          isFormValid &= validateField(
            telefono,
            "telefono-error",
            validatePhone,
            showErrors
          );

          // Habilitar/deshabilitar botón
          submitBtn.disabled = !isFormValid;

          return isFormValid;
        }

        // Validar en tiempo real
        [dni, nombre, apellido, direccion, telefono].forEach((field) => {
          field.addEventListener("input", () => validateForm(false));
          field.addEventListener("blur", (e) => {
            e.target.dataset.touched = "true";
            validateForm(true);
          });
        });

        // Validar al enviar el formulario
        form.addEventListener("submit", function (e) {
          e.preventDefault();

          // Marcar todos los campos como tocados y mostrar errores
          [dni, nombre, apellido, direccion, telefono].forEach((field) => {
            field.dataset.touched = "true";
          });

          if (validateForm(true)) {
            // Si todo está válido, enviar el formulario
            const formData = new FormData(form);

            // Deshabilitar botón durante el envío
            submitBtn.disabled = true;
            submitBtn.textContent = "Registrando...";

            fetch("/registrar", {
              method: "POST",
              body: formData,
            })
              .then((response) => {
                if (response.ok) {
                  // Mostrar modal de éxito
                  modal.style.display = "block";
                  // Limpiar formulario
                  form.reset();
                  // Restaurar botón
                  submitBtn.disabled = false;
                  submitBtn.textContent = "Registrar";
                } else {
                  throw new Error("Error en el servidor");
                }
              })
              .catch((error) => {
                alert("Error al registrar. Por favor, intente nuevamente.");
                submitBtn.disabled = false;
                submitBtn.textContent = "Registrar";
              });
          }
        });

        // Cerrar modal
        document.querySelector(".close").addEventListener("click", function () {
          modal.style.display = "none";
        });

        // Cerrar modal al hacer clic fuera
        window.addEventListener("click", function (e) {
          if (e.target === modal) {
            modal.style.display = "none";
          }
        });

        // Validación inicial
        validateForm();
      });
    </script>
  </body>
</html>
